<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="UTF-8">
  <title> Admin dashboard </title>
  <link rel="stylesheet" href="css/scan.css">
  <link rel="stylesheet" href="css/color.css">
  <!-- <link rel="stylesheet" href="css/common.css"> -->
  <link rel="stylesheet" href="css/button.css">

  <!-- Boxicons CDN Link -->
  <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
  <!--sidebar begins here-->
  <div class="sidebar">
    <div class="logo-details">
      <i class='bx bxl-t-plus-plus'></i>
      <!--type of icon-->
      <span class="logo_name">TrackMe</span>
    </div>
    <ul class="nav-links">
      <li>
        <a href="index.html">
          <i class='bx bx-grid-alt'></i>
          <span class="links_name">Dashboard</span>
        </a>
      </li>
      <li>
        <a href="report.html">
          <i class='bx bx-edit'></i>
          <span class="links_name">Report</span>
        </a>
      </li>
      <li>
        <a href="barcode.html">
          <i class='bx bx-barcode'></i>
          <span class="links_name">Barcode</span>
        </a>
      </li>
      <li>
        <a href="#" class="active">
          <i class='bx bx-scan'></i>
          <span class="links_name">Scan</span>
        </a>
      </li>
      <li>
        <a href="workers.html">
          <i class='bx bx-user'></i>
          <span class="links_name">Workers</span>
        </a>
      </li>
      <li class="log_out">
        <a href="#">
          <i class='bx bx-log-out'></i>
          <span class="links_name">Log out</span>
        </a>
      </li>
    </ul>
  </div>

  <!-- sidebar ends here -->
  <section class="home-section">
    <nav>
      <div class="sidebar-button">
        <i class='bx bx-menu sidebarBtn'></i>
        <span class="dashboard">Dashboard</span>
      </div>

      <div class="profile-details">
        <!--<img src="images/profile.jpg" alt="">-->
        <span class="admin_name">Admin</span>
        <i class='bx bx-chevron-down'></i>
      </div>
    </nav>

    <div class="scan-body">

      <h3>FFB Products Section</h3>
      <hr />
      <div class="dashboard-section">
        <div id="scan-user">
          <a class="user-trigger" href="#">Get Employee</a>
        </div>
        <div id="check-in">
          <a class="checkIn-trigger" href="#">Check in Goods</a>
        </div>
        <div id="check-out">
          <a class="checkOut-trigger" href="#">Check out Goods</a>
        </div>
      </div>

      <h3>Employees Section</h3>
      <hr />
      <div class="dashboard-section">
        <div id="loginEmp">
          <a class="login-trigger" href="#">Log in Employee</a>
        </div>
        <div id="logoutEmp">
          <a class="logout-trigger" href="#">Log out Employee</a>
        </div>
      </div>
    </div>

    <div class="user-modal">
      <div class="modal-content">
        <span class="user-close-button"><i class="bx bx-x"></i></span>
        <h1>Scan Users badge</h1>
        <hr />
        <div class="col">
          <div id="reader" width="00px"></div>
        </div>
      </div>
    </div>

    <div class="checkin-modal">
      <div class="modal-content">
        <span class="checkin-close-button"><i class="bx bx-x"></i></span>
        <h1>Check-In Goods</h1>
        <hr />
        <div class="col">
          <div id="reader" width="00px"></div>
        </div>
      </div>
    </div>

    <div class="checkout-modal">
      <div class="modal-content">
        <span class="checkout-close-button"><i class="bx bx-x"></i></span>
        <h1>Scan Goods</h1>
        <hr />
        <div class="col">
          <div id="reader" width="00px"></div>
        </div>
      </div>
    </div>

  </section>












  <script>
    let sidebar = document.querySelector(".sidebar");
    let sidebarBtn = document.querySelector(".sidebarBtn");
    sidebarBtn.onclick = function () {
      sidebar.classList.toggle("active");
      if (sidebar.classList.contains("active")) {
        sidebarBtn.classList.replace("bx-menu", "bx-menu-alt-right");
      } else
        sidebarBtn.classList.replace("bx-menu-alt-right", "bx-menu");
    }

  </script>


  <script src="./js/date.js"></script>
  <script src="./js/generate_dashboard_table.js"></script>
  <script src="./js/utils.js"></script>
  <script src="./js/firebase.js"></script>
  <script src="js/html5-qrcode.min.js"></script>

  <!-- Firebase sdk setup -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp, } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import {
      getFirestore,
      getDocs,
      collection,
      setDoc,
      updateDoc,
      deleteDoc,
      doc,
      query,
      where,
    } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: config.apiKey,
      authDomain: config.authDomain,
      projectId: config.projectId,
      storageBucket: config.storageBucket,
      messagingSenderId: config.messagingSenderId,
      appId: config.appId
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);


    //Firestore connection
    const database = getFirestore(app);

    const updateCheckInRef = (code) => {
      return updateDoc(doc(database, BARCODE, code.id), code);
    };

    const updateCheckOutRef = (code) => {
      return updateDoc(doc(database, BARCODE, code.id), code);
    }

    const updateCode = async (code) => {
      const querySnapshot = await updateCheckInRef(code);
      alert("Code check-in updated");
    }

    const updateCheckOut = async (code) => {
      const querySnapshot = await updateCheckOutRef(code);
      alert("Code check-out updated");
    }

    // This function builds the query for daily fbb count in firestore database
    const getBarcodeQuery = () => {
      return getDocs(collection(database, BARCODE));
    };

    // This function builds the query for all users count in firestore database
    const getCodeQuery = (code) => {
      const q = query(collection(database, BARCODE), where("code", "==", code));
      return getDocs(q);

    };

    const getCode = async (code) => {
      const querySnapshot = await getCodeQuery(code);
      let barcodes = [];
      querySnapshot.forEach((doc) => {
        barcodes.push({ ...doc.data() });
      });

      return barcodes[0];
    }

    const scanUser = document.getElementById("scan-user");
    const checkIn = document.getElementById("check-in");
    const checkOut = document.getElementById("check-out");


    const onScanSuccess = async (decodedText, decodedResult) => {
      // handle the scanned code as you like, for example:
      let data = await getCode(parseInt(decodedText));
      let checkoutCode = await getCode(parseInt(decodedText));

      data.checked_in = true; //update 1 value ie check-in
      checkoutCode.checked_out = true;

      await updateCode(data);
      await updateCheckOut(checkoutCode);
    }


    let QRconfig = {
      fps: 10,
      qrbox: { width: 250, height: 250 },
      rememberLastUsedCamera: true,
      // Only support camera scan type.
      supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
    };

    let html5QrcodeScanner = new Html5QrcodeScanner(
      "reader", QRconfig, /* verbose= */ false);
    html5QrcodeScanner.render(onScanSuccess);
  </script>

  <script>
    // modal functionality
    const userModal = document.querySelector(".user-modal");
    const userTrigger = document.querySelector(".user-trigger");
    const userCloseButton = document.querySelector(".user-close-button");

    const toggleModal = () => {
      userModal.classList.toggle("show-modal");
    }

    function windowOnClick(event) {
      if (event.target === userModal) {
        toggleModal();
      }
    }

    userTrigger.addEventListener("click", toggleModal);
    userCloseButton.addEventListener("click", toggleModal);
    window.addEventListener("click", windowOnClick);
  </script>

  <script>
    // modal functionality
    const checkinModal = document.querySelector(".checkin-modal");
    const checkinTrigger = document.querySelector(".checkIn-trigger");
    const checkinCloseButton = document.querySelector(".checkin-close-button");

    const toggleModal2 = () => {
      checkinModal.classList.toggle("show-modal");
    }

    function windowOnClick(event) {
      if (event.target === checkinModal) {
        toggleModal();
      }
    }

    checkinTrigger.addEventListener("click", toggleModal);
    checkinCloseButton.addEventListener("click", toggleModal);
    window.addEventListener("click", windowOnClick);
  </script>

  <script>
    // modal functionality
    const checkoutModal = document.querySelector(".checkout-modal");
    const checkoutTrigger = document.querySelector(".checkOut-trigger");
    const checkoutCloseButton = document.querySelector(".checkout-close-button");

    const toggleModal3 = () => {
      checkoutModal.classList.toggle("show-modal");
    }

    function windowOnClick(event) {
      if (event.target === checkoutModal) {
        toggleModal();
      }
    }

    checkoutTrigger.addEventListener("click", toggleModal);
    checkoutCloseButton.addEventListener("click", toggleModal);
    window.addEventListener("click", windowOnClick);
  </script>


</body>

</html>